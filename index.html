<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LobeNext v4.0 Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root {
            --glass-bg: rgba(15, 15, 15, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { -webkit-tap-highlight-color: transparent; outline: none !important; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #000;
            background-image: radial-gradient(circle at 50% 0%, #2a2a2a 0%, #000 80%);
            color: #fff;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
        }

        .scroll-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 200px;
        }

        /* æ¨™ç±¤åˆ†é¡æ¨£å¼ */
        .tag-badge { @apply text-[9px] px-2 py-0.5 rounded-md font-bold ml-auto shrink-0; }
        .tag-æ¨è–¦ { @apply bg-green-500/20 text-green-400; }
        .tag-è¼•é‡ { @apply bg-blue-500/20 text-blue-400; }
        .tag-å¿«é€Ÿ { @apply bg-orange-500/20 text-orange-400; }
        .tag-ä¸å»ºè­° { @apply bg-red-500/20 text-red-400; }

        .hero-text {
            font-size: clamp(1.8rem, 8vw, 2.8rem);
            font-weight: 800;
            background: linear-gradient(to bottom, #fff 40%, #555 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ä¸‹æ‹‰é¸å–®æ‰‹æ©Ÿå„ªåŒ– */
        .select-options {
            @apply fixed bottom-32 left-[5%] w-[90%] glass rounded-[24px] p-2 shadow-2xl z-[100] hidden flex-col max-h-[50vh] overflow-y-auto border-white/20;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .bubble { @apply max-w-[90%] p-4 rounded-[22px] shadow-lg mb-4 text-[15px] leading-relaxed transition-all; }
        .bubble-user { @apply bg-white text-black self-end rounded-br-none; }
        .bubble-ai { @apply glass text-white self-start rounded-bl-none; }
        
        .nav-btn { @apply flex-1 flex flex-col items-center justify-center gap-1 text-gray-500; }
        .nav-btn.active { @apply text-white; }
    </style>
</head>
<body>

    <div class="h-[env(safe-area-inset-top)]"></div>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <div id="view-home" class="scroll-content px-4">
            <!-- å•Ÿå‹•ä»‹é¢ -->
            <div id="hero-section" class="flex flex-col items-center justify-center text-center pt-28 pb-10 space-y-4">
                <div class="w-16 h-16 bg-white/5 rounded-3xl flex items-center justify-center border border-white/10 mb-2">
                    <i class="fas fa-ghost text-3xl"></i>
                </div>
                <h1 id="displayHeroText" class="hero-text">å†æ¬¡å•Ÿå‹•é«˜æ•ˆæ¨¡å¼ï¼</h1>
                <p class="text-gray-500 text-sm">AI ä»£ç†å·²å•Ÿç”¨ Â· æœ€ä½³æ¨¡å‹å‹•æ…‹åŒ¹é…</p>
            </div>

            <!-- èŠå¤©ç´€éŒ„ -->
            <div id="chatHistory" class="hidden flex flex-col pt-10 pb-10"></div>
        </div>

        <!-- è¨­å®šä»‹é¢ -->
        <div id="view-settings" class="hidden scroll-content px-6 pt-10">
            <h2 class="text-3xl font-bold mb-10 text-white">è¨­å®š</h2>
            <div class="space-y-6">
                <div class="glass p-6 rounded-[30px] space-y-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">è‡ªå®šç¾© API KEY</label>
                    <input type="password" id="customApiKey" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-white" placeholder="è¼¸å…¥æ‚¨çš„ Gemini Key...">
                    <button onclick="applySettings()" class="w-full bg-white text-black py-4 rounded-xl font-bold active:scale-95 transition-all">å¥—ç”¨è¨­å®š</button>
                </div>
                <div class="glass p-6 rounded-[30px] space-y-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">é¦–é æ¨™é¡Œ</label>
                    <input type="text" id="inputHeroText" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-white">
                </div>
            </div>
        </div>

        <!-- è¼¸å…¥æ¬„èˆ‡æ¨¡å‹åˆ‡æ› -->
        <div id="input-bar" class="fixed bottom-24 left-0 w-full px-4 z-50">
            <div class="glass rounded-[30px] p-2">
                <textarea id="userInput" rows="1" class="w-full bg-transparent border-none focus:ring-0 px-4 py-3 text-white placeholder-gray-600 resize-none max-h-32 text-base" placeholder="å‚³é€è¨Šæ¯..."></textarea>
                
                <div class="flex items-center justify-between px-3 pb-2">
                    <div class="relative">
                        <div id="modelTrigger" class="flex items-center gap-2 bg-white/10 border border-white/10 rounded-full px-4 py-1.5 text-[11px] font-bold" onclick="toggleModelList(event)">
                            <span id="selectedModelLabel">æ­£åœ¨åµæ¸¬ç’°å¢ƒ...</span>
                            <i class="fas fa-chevron-up text-[8px] opacity-40"></i>
                        </div>
                        <div id="modelOptions" class="select-options"></div>
                    </div>
                    <button id="sendBtn" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center active:scale-90 shadow-lg">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å°èˆª -->
        <nav class="fixed bottom-0 left-0 w-full h-[85px] flex glass bg-black/50 pt-2 pb-[env(safe-area-inset-bottom)] border-t-0">
            <div onclick="switchTab('home')" id="nav-home" class="nav-btn active">
                <i class="fas fa-comment-dots text-xl"></i>
                <span class="text-[10px] mt-1 font-bold">å°è©±</span>
            </div>
            <div onclick="switchTab('settings')" id="nav-settings" class="nav-btn">
                <i class="fas fa-sliders-h text-xl"></i>
                <span class="text-[10px] mt-1 font-bold">è¨­å®š</span>
            </div>
        </nav>
    </main>

    <script>
        const state = {
            apiKey: sessionStorage.getItem('next_api_key') || '',
            heroText: localStorage.getItem('next_hero_text') || 'å†æ¬¡å•Ÿå‹•é«˜æ•ˆæ¨¡å¼ï¼',
            models: [], messages: [], selectedModel: '', selectedProvider: '', isHome: true
        };

        const dom = {
            chatHistory: document.getElementById('chatHistory'),
            heroSection: document.getElementById('hero-section'),
            userInput: document.getElementById('userInput'),
            modelOptions: document.getElementById('modelOptions'),
            selectedModelLabel: document.getElementById('selectedModelLabel'),
            displayHeroText: document.getElementById('displayHeroText')
        };

        async function init() {
            dom.displayHeroText.textContent = state.heroText;
            document.getElementById('inputHeroText').value = state.heroText;
            document.getElementById('customApiKey').value = state.apiKey;
            await reloadModels();

            dom.userInput.oninput = function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            };

            document.getElementById('sendBtn').onclick = sendMessage;
            window.onclick = (e) => { if (!e.target.closest('.relative')) dom.modelOptions.classList.add('hidden'); };
        }

        async function reloadModels() {
            try {
                const headers = state.apiKey ? { 'x-custom-api-key': state.apiKey } : {};
                const res = await fetch('/api/models', { headers });
                const data = await res.json();
                state.models = data.models;
                
                dom.modelOptions.innerHTML = data.models.map(m => {
                    const tagType = m.tag.replace(/[âœ…ğŸƒâš¡âš ï¸]/g, '').trim();
                    return `
                        <div class="px-5 py-4 rounded-2xl text-sm mb-1 active:bg-white/10 flex items-center" 
                             onclick="selectModel('${m.id}', '${m.name}', '${m.provider}')">
                            <span class="truncate mr-2">${m.name}</span>
                            <span class="tag-badge tag-${tagType}">${m.tag}</span>
                            ${m.id === state.selectedModel ? '<i class="fas fa-check text-blue-400 ml-2"></i>' : ''}
                        </div>
                    `;
                }).join('');

                if (data.models.length > 0 && !state.selectedModel) {
                    const first = data.models[0];
                    selectModel(first.id, first.name, first.provider);
                }
            } catch (e) { dom.selectedModelLabel.textContent = "API é€£ç·šç•°å¸¸"; }
        }

        function selectModel(id, name, provider) {
            state.selectedModel = id;
            state.selectedProvider = provider;
            dom.selectedModelLabel.textContent = name;
            dom.modelOptions.classList.add('hidden');
            reloadModels();
        }

        function toggleModelList(e) { e.stopPropagation(); dom.modelOptions.classList.toggle('hidden'); }

        function switchTab(tab) {
            state.isHome = (tab === 'home');
            document.getElementById('view-home').classList.toggle('hidden', !state.isHome);
            document.getElementById('view-settings').classList.toggle('hidden', state.isHome);
            document.getElementById('nav-home').classList.toggle('active', state.isHome);
            document.getElementById('nav-settings').classList.toggle('active', !state.isHome);
            document.getElementById('input-bar').style.display = state.isHome ? 'block' : 'none';
        }

        function applySettings() {
            state.apiKey = document.getElementById('customApiKey').value.trim();
            state.heroText = document.getElementById('inputHeroText').value.trim() || 'å†æ¬¡å•Ÿå‹•é«˜æ•ˆæ¨¡å¼ï¼';
            sessionStorage.setItem('next_api_key', state.apiKey);
            localStorage.setItem('next_hero_text', state.heroText);
            location.reload();
        }

        async function sendMessage() {
            const text = dom.userInput.value.trim();
            if(!text) return;

            dom.heroSection.classList.add('hidden');
            dom.chatHistory.classList.remove('hidden');

            appendBubble('user', text);
            dom.userInput.value = '';
            dom.userInput.style.height = 'auto';

            const aiBubble = appendBubble('assistant', 'èˆ‡ä»£ç†ä¼ºæœå™¨æ¡æ‰‹ä¸­...', state.selectedModel);

            try {
                state.messages.push({ role: 'user', content: text });
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-custom-api-key': state.apiKey },
                    body: JSON.stringify({ model: state.selectedModel, provider: state.selectedProvider, messages: state.messages })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                
                updateBubble(aiBubble, data.content);
                state.messages.push({ role: 'assistant', content: data.content });
            } catch (e) { updateBubble(aiBubble, "è«‹æ±‚å¤±æ•—: " + e.message, true); }
        }

        function appendBubble(role, content, model = "") {
            const div = document.createElement('div');
            div.className = `bubble ${role === 'user' ? 'bubble-user' : 'bubble-ai'}`;
            div.innerHTML = `
                ${role === 'assistant' ? `<div class="text-[9px] font-bold text-gray-500 mb-1 uppercase">${model}</div>` : ''}
                <div class="whitespace-pre-wrap">${content}</div>
            `;
            dom.chatHistory.appendChild(div);
            const scrollBox = document.getElementById('view-home');
            scrollBox.scrollTo({ top: scrollBox.scrollHeight, behavior: 'smooth' });
            return div;
        }

        function updateBubble(div, content, isError = false) {
            const target = div.querySelector('.whitespace-pre-wrap');
            if(isError) target.classList.add('text-red-400');
            target.textContent = content;
            const scrollBox = document.getElementById('view-home');
            scrollBox.scrollTo({ top: scrollBox.scrollHeight, behavior: 'smooth' });
        }

        init();
    </script>
</body>
    </html>
