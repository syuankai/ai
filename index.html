<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LobeChat | CloudAI Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap');
        
        :root {
            --lobe-bg: #000000;
            --lobe-sidebar: #000000;
            --lobe-card: #161616;
            --lobe-input: #1d1d1d;
            --lobe-text: #e1e1e1;
            --lobe-secondary: #888888;
            --primary-accent: #ffffff;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--lobe-bg);
            color: var(--lobe-text);
            height: 100vh;
            margin: 0;
            display: flex;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* å´é‚Šæ¬„æ¨£å¼ */
        .sidebar-icon {
            @apply flex items-center justify-center w-10 h-10 rounded-xl text-xl transition-all cursor-pointer;
            color: var(--lobe-secondary);
        }
        .sidebar-icon:hover { background: #222; color: #fff; }
        .sidebar-icon.active { background: #1a1a1a; color: #fff; }

        /* ä¸­å¤®è¼¸å…¥æ¡†æ¨£å¼ */
        .search-container {
            background: var(--lobe-card);
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        /* åŠ©æ‰‹å¡ç‰‡ */
        .assistant-card {
            background: var(--lobe-card);
            border: 1px solid #222;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .assistant-card:hover {
            border-color: #444;
            background: #1c1c1c;
            transform: translateY(-2px);
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* WebView å®‰å…¨å€åŸŸ */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }

        /* æ‰“å­—æ©Ÿæ•ˆæœè—é» */
        .cursor-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #0066ff;
            border-radius: 50%;
            margin-left: 4px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <!-- å·¦å´å°è¦½åˆ— (å®Œå…¨é‚„åŸæˆªåœ–) -->
    <aside class="w-[64px] flex flex-col items-center py-4 border-r border-[#1a1a1a] shrink-0">
        <div class="mb-8">
            <img src="https://lobechat.com/logo.png" class="w-8 h-8 rounded-lg" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=lobe'">
        </div>
        
        <div class="flex-1 flex flex-col gap-4">
            <div class="sidebar-icon"><i class="fas fa-search"></i></div>
            <div class="sidebar-icon active"><i class="fas fa-home"></i></div>
            <div class="sidebar-icon"><i class="fas fa-file-alt"></i></div>
            <div class="sidebar-icon"><i class="fas fa-video"></i></div>
            <div class="sidebar-icon"><i class="fas fa-paint-brush"></i></div>
            <div class="sidebar-icon"><i class="fas fa-users"></i></div>
        </div>

        <div class="flex flex-col gap-4 mt-auto">
            <div class="sidebar-icon" onclick="toggleSettings()"><i class="fas fa-cog"></i></div>
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 overflow-hidden border border-[#333]">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=popcat" alt="avatar">
            </div>
        </div>
    </aside>

    <!-- ä¸»è¦–çª— -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <!-- é ‚éƒ¨æ¨¡å‹é¸æ“‡å™¨ (WebView å°ˆç”¨ç°¡æ½”ç‰ˆ) -->
        <header class="h-14 flex items-center justify-between px-6 z-10">
            <div class="flex items-center gap-2 cursor-pointer" onclick="toggleSettings()">
                <span id="currentModelName" class="font-bold text-sm tracking-wide">Gemini 1.5 Flash</span>
                <i class="fas fa-chevron-down text-[10px] text-gray-500"></i>
            </div>
            <div class="flex gap-4 text-gray-500">
                <i class="fas fa-expand-alt cursor-pointer hover:text-white"></i>
            </div>
        </header>

        <!-- å…§å®¹æ»¾å‹•å€ -->
        <div id="scrollContent" class="flex-1 overflow-y-auto no-scrollbar pt-10 px-6 pb-20">
            
            <!-- å†æ¬¡å•Ÿå‹•é«˜æ•ˆæ¨¡å¼ï¼ -->
            <div id="homeHero" class="max-w-4xl mx-auto space-y-12">
                <h1 class="text-3xl md:text-5xl font-bold text-center mt-10">å†æ¬¡å•Ÿå‹•é«˜æ•ˆæ¨¡å¼ï¼</h1>

                <!-- ç½®ä¸­è¼¸å…¥å°è©±æ¡† -->
                <div class="search-container p-4">
                    <textarea id="userInput" rows="3" 
                        class="w-full bg-transparent border-none focus:ring-0 text-lg text-white placeholder-gray-600 resize-none"
                        placeholder="è©¢å•ã€å‰µä½œæˆ–é–‹å§‹ä»»å‹™ï¼ŒæŒ‰ Shift+Enter æ›è¡Œ..."></textarea>
                    
                    <div class="flex items-center justify-between mt-4">
                        <div class="flex gap-4 text-gray-500">
                            <i class="fas fa-magic cursor-pointer hover:text-white"></i>
                            <i class="fas fa-paperclip cursor-pointer hover:text-white"></i>
                            <i class="fas fa-microphone cursor-pointer hover:text-white"></i>
                            <i class="fas fa-th-large cursor-pointer hover:text-white"></i>
                        </div>
                        <button id="sendBtn" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="flex justify-center gap-4 text-sm font-medium">
                    <button class="px-6 py-2 bg-[#161616] border border-[#222] rounded-full hover:bg-[#222] flex items-center gap-2">
                        <i class="fas fa-robot text-gray-500"></i> å»ºç«‹åŠ©ç†
                    </button>
                    <button class="px-6 py-2 bg-[#161616] border border-[#222] rounded-full hover:bg-[#222] flex items-center gap-2">
                        <i class="fas fa-layer-group text-gray-500"></i> å»ºç«‹ç¾¤çµ„
                    </button>
                    <button class="px-6 py-2 bg-[#161616] border border-[#222] rounded-full hover:bg-[#222] flex items-center gap-2">
                        <i class="fas fa-pen-nib text-gray-500"></i> å¯«ä½œ
                    </button>
                </div>

                <!-- ç¤¾ç¾¤åŠ©æ‰‹ Grid -->
                <div class="pt-10">
                    <div class="flex items-center gap-2 mb-6 text-gray-400 font-bold">
                        <i class="fas fa-robot"></i> ç¤¾ç¾¤åŠ©æ‰‹
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="assistant-card space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-black font-bold">AI</div>
                                <i class="fas fa-tag text-gray-600"></i>
                            </div>
                            <h3 class="font-bold">éŠ·å”®æè¿°å°ˆå®¶</h3>
                            <p class="text-xs text-gray-500 leading-relaxed">å”åŠ©äºŒæ‰‹ç‰©å“çš„éŠ·å”®ï¼ŒåŒ…æ‹¬æœå°‹è³‡è¨Šã€å®šåƒ¹...</p>
                        </div>
                        <div class="assistant-card space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-apple-whole"></i></div>
                                <i class="fas fa-desktop text-gray-600"></i>
                            </div>
                            <h3 class="font-bold">Apple Silicon å„ªåŒ–å™¨</h3>
                            <p class="text-xs text-gray-500 leading-relaxed">å°ˆç‚º M1/M2/M3 æœ€ä½³åŒ– ComfyUI å®‰è£èˆ‡åŸ·è¡Œ...</p>
                        </div>
                        <div class="assistant-card space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-gamepad"></i></div>
                                <i class="fas fa-microchip text-gray-600"></i>
                            </div>
                            <h3 class="font-bold">å¤¢å¹»æ™ºè¬€å¸«</h3>
                            <p class="text-xs text-gray-500 leading-relaxed">è³‡æ·±éŠæˆ²ç©å®¶æˆ°è¡“åˆ†æï¼Œæä¾›å¯µç‰©é¤Šæˆèˆ‡ PK ç­–ç•¥...</p>
                        </div>
                        <div class="assistant-card space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-clapperboard"></i></div>
                                <i class="fas fa-bookmark text-gray-600"></i>
                            </div>
                            <h3 class="font-bold">çŸ­åŠ‡ç·¨åŠ‡å¤§å¸«</h3>
                            <p class="text-xs text-gray-500 leading-relaxed">å°ˆæ¥­çŸ­è¦–é »åŠ‡æœ¬å‰µä½œå°ˆå®¶ï¼Œå°ˆæ³¨æ–¼é«˜è¡çª...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å°è©±å…§å®¹å€ (ç™¼é€è¨Šæ¯å¾Œé¡¯ç¤º) -->
            <div id="chatMessages" class="hidden max-w-4xl mx-auto space-y-10 pt-4"></div>
        </div>
    </main>

    <!-- è¨­ç½®æŠ½å±œ (API Keys) -->
    <div id="settingsDrawer" class="fixed inset-y-0 right-0 w-80 bg-[#0d0d0d] border-l border-[#222] z-50 translate-x-full transition-transform duration-300 p-6 space-y-8 overflow-y-auto">
        <div class="flex justify-between items-center">
            <h2 class="font-bold text-lg">ç³»çµ±è¨­å®š</h2>
            <i class="fas fa-times cursor-pointer p-2" onclick="toggleSettings()"></i>
        </div>

        <div class="space-y-4">
            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">é¸æ“‡æ¨¡å‹</label>
            <select id="modelSelect" class="w-full bg-[#1a1a1a] border-none rounded-xl p-3 text-sm focus:ring-1 focus:ring-white/20"></select>
        </div>

        <div class="space-y-4">
            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest">API KEY æ³¨å…¥</label>
            <input type="password" id="key-gemini" class="w-full bg-[#1a1a1a] border-none rounded-xl p-3 text-sm" placeholder="Gemini API Key">
            <input type="password" id="key-openai" class="w-full bg-[#1a1a1a] border-none rounded-xl p-3 text-sm" placeholder="OpenAI API Key">
            <input type="password" id="key-deepseek" class="w-full bg-[#1a1a1a] border-none rounded-xl p-3 text-sm" placeholder="DeepSeek API Key">
            <button onclick="saveKeys()" class="w-full py-3 bg-white text-black rounded-xl font-bold">æ›´æ–°èˆ‡æ‡‰ç”¨</button>
        </div>

        <div class="pt-10 border-t border-[#222] text-[10px] text-gray-600 text-center">
            CloudAI Hub | WebView Adaptive Mode v3.0
        </div>
    </div>

    <script>
        const state = {
            keys: JSON.parse(sessionStorage.getItem('ai_keys') || '{}'),
            models: [],
            isHome: true
        };

        const scrollContent = document.getElementById('scrollContent');
        const homeHero = document.getElementById('homeHero');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const modelSelect = document.getElementById('modelSelect');

        async function init() {
            // è¼‰å…¥é‡‘é‘°åˆ° Input
            Object.keys(state.keys).forEach(id => {
                const el = document.getElementById('key-' + id);
                if(el) el.value = state.keys[id];
            });

            await reloadModels();

            document.getElementById('sendBtn').onclick = handleSend;
            userInput.onkeydown = (e) => {
                if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
            };
            
            modelSelect.onchange = () => {
                document.getElementById('currentModelName').textContent = modelSelect.options[modelSelect.selectedIndex].text;
            };
        }

        function toggleSettings() {
            document.getElementById('settingsDrawer').classList.toggle('translate-x-full');
        }

        function saveKeys() {
            const keys = {
                gemini: document.getElementById('key-gemini').value.trim(),
                openai: document.getElementById('key-openai').value.trim(),
                deepseek: document.getElementById('key-deepseek').value.trim()
            };
            sessionStorage.setItem('ai_keys', JSON.stringify(keys));
            state.keys = keys;
            reloadModels();
            toggleSettings();
        }

        async function reloadModels() {
            try {
                const headers = {};
                Object.keys(state.keys).forEach(k => headers[`x-key-${k}`] = state.keys[k]);
                const res = await fetch('/api/models', { headers });
                const data = await res.json();
                state.models = data.models;
                modelSelect.innerHTML = data.models.map(m => `<option value="${m.id}" data-provider="${m.provider}">${m.name} ${m.isCustom ? 'ğŸ’' : ''}</option>`).join('');
                modelSelect.dispatchEvent(new Event('change'));
            } catch (e) { console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—"); }
        }

        async function handleSend() {
            const text = userInput.value.trim();
            if(!text) return;

            if(state.isHome) {
                homeHero.classList.add('hidden');
                chatMessages.classList.remove('hidden');
                state.isHome = false;
            }

            appendMessage('user', text);
            userInput.value = '';
            
            const selectedOpt = modelSelect.options[modelSelect.selectedIndex];
            const aiBubble = appendMessage('assistant', 'æ­£åœ¨è¨ˆç®—ä¸­...', selectedOpt.text);

            try {
                const headers = { 'Content-Type': 'application/json' };
                Object.keys(state.keys).forEach(k => headers[`x-key-${k}`] = state.keys[k]);

                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        model: modelSelect.value,
                        provider: selectedOpt.dataset.provider,
                        messages: [{ role: 'user', content: text }]
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                updateAIBubble(aiBubble, data.content);
            } catch (e) {
                updateAIBubble(aiBubble, "âŒ éŒ¯èª¤: " + e.message);
            }
        }

        function appendMessage(role, content, modelName = "") {
            const div = document.createElement('div');
            div.className = `flex gap-4 ${role === 'user' ? 'justify-end' : 'justify-start'} group`;
            
            const inner = `
                <div class="flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} max-w-[90%] md:max-w-[80%]">
                    ${role === 'assistant' ? `<div class="text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest">${modelName}</div>` : ''}
                    <div class="${role === 'user' ? 'bg-[#fff] text-[#000] rounded-[20px] rounded-br-none' : 'bg-[#161616] border border-[#222] text-[#e1e1e1] rounded-[20px] rounded-bl-none'} p-4 shadow-lg">
                        <div class="text-[15px] leading-relaxed whitespace-pre-wrap">${content}</div>
                    </div>
                </div>
            `;
            div.innerHTML = inner;
            chatMessages.appendChild(div);
            scrollContent.scrollTop = scrollContent.scrollHeight;
            return div;
        }

        function updateAIBubble(div, content) {
            const body = div.querySelector('.p-4 div');
            body.textContent = content;
            scrollContent.scrollTop = scrollContent.scrollHeight;
        }

        init();
    </script>
</body>
</html>
